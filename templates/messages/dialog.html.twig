{% block title %}{% if selectedUser %}Dialog with {{ selectedUser.username }}{% else %}<h1>Select a User to start a dialog</h1>{% endif %}{% endblock %}
{% block body %}
    {% if selectedUser %}
    <h1>Dialog with {{ selectedUser.username }}</h1>

    <div>
        <ul id="message-list">
            {% for message in messages %}
                <li>
                    <strong>{{ message.sender }}</strong>: {{ message.content }}
                </li>
            {% endfor %}
        </ul>
    </div>

    <hr>

    <h2>Send a Message</h2>

    {{ form_start(messageForm) }}
    {{ form_row(messageForm.content) }}

    <button type="submit" class="btn btn-primary">Send</button>
    {{ form_end(messageForm) }}

    {% else %}
        <ul>
            {% for user in users %}
                <li><a href="{{ path('app_dialog', {id: user.id}) }}">{{ user.username }}</a></li>
            {% endfor %}
        </ul>
    {% endif %}
{% endblock %}

{% block javascripts %}
    {% if selectedUser %}
    <script>
        function fetchUpdates() {
            // Fetch updates from the server using an AJAX request
            fetch("{{ path('fetch_dialog_updates', { 'id': selectedUser ? selectedUser.id : null }) }}")
                .then(response => response.json())
                .then(data => {
                    // Handle the received data and update the UI
                    const messageList = document.getElementById('message-list');
                    messageList.innerHTML = ''; // Clear existing messages
                    data.forEach(message => {
                        const newMessage = document.createElement('li');
                        newMessage.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`; // Access message attributes directly
                        messageList.appendChild(newMessage);
                    });
                })
                .catch(error => console.error('Error fetching updates:', error));
        }

        // Fetch updates immediately when the page loads
        fetchUpdates();

        // Fetch updates every 5 seconds (adjust this interval as needed)
        setInterval(fetchUpdates, 500);
    </script>
{#   Mercure logic     #}
{#        <script>#}
{#            const dialogId = {{ id|json_encode|raw }};#}

{#            // Subscribe to the Mercure hub for real-time updates#}
{#            const eventSource = new EventSource("{{ mercure('/dialog/' ~ id)|escape('js') }}");#}

{#            // Handle incoming messages#}
{#            eventSource.onmessage = function(event) {#}
{#                console.log('jopa')#}
{#                const data = JSON.parse(event.data);#}
{#                // Update the UI with the new message#}
{#                const messageList = document.getElementById('message-list');#}
{#                const newMessage = document.createElement('li');#}
{#                newMessage.innerHTML = `<strong>${data.sender.username}</strong>: ${data.content}`;#}
{#                messageList.appendChild(newMessage);#}
{#            };#}
{#        </script>#}
    {% endif %}
{% endblock %}
